version: '3'

services:
  web:
    container_name: web
    build:
      context: ./web
      dockerfile: dockerfile
    image: webcast-web:latest
    expose:
      - 80
      - 22
    networks:
      - net

  rtmp:
    container_name: rtmp
    build:
      context: ./rtmp
      dockerfile: dockerfile
    image: webcast-rtmp:latest
    depends_on:
      - web
    expose:
      - 1935
      - 8080
      - 22
    networks:
      - net
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined

  loadbalancer:
    container_name: loadbalancer
    build:
      context: ./haproxy
      dockerfile: dockerfile
    image: webcast-haproxy:latest
    depends_on:
      - web
      - rtmp
    environment:
      - BALANCE=leastconn
    ports:
      - 80:80
      - 1935:1935
      - 1936:1936
      - 8080:8080
      - 3000:3000
    networks:
      - net

networks:
  net:
    driver: bridge
